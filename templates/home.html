<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Period Tracker - Home</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
        
    <style>
        /* (CSS ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap');

        body {
            padding-top: 80px; /* ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‚≠êÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏° padding ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            padding-bottom: 70px;
            margin: 0;
            font-family: 'Kanit', sans-serif;
            background-color: #d5e5f3; 
            color: #333333;
            background-image: url({{ url_for('static', filename='bg.jpg') }});
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        .top-nav {
            position: fixed;
            top: 0;
            width: 100%;
            display: flex;
            justify-content: flex-start;
            align-items: center; /* ‚≠êÔ∏è [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‚≠êÔ∏è */
            background-color: #b0d3f2;
            border-bottom: 1px solid #b0d3f2;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 1000;
            gap: 20px;
        }
        /* ‚≠êÔ∏è [‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] ‚≠êÔ∏è */
        .user-info {
            margin-left: auto; /* ‡∏î‡∏±‡∏ô‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤‡∏™‡∏∏‡∏î */
            padding-right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }
        .logout-btn {
            background: #FB6A90;
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9em;
            transition: background 0.2s;
            border: none;
            cursor: pointer;
        }
        .logout-btn:hover {
            background: #d6336c;
        }
        /* ‚≠êÔ∏è [‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î CSS ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°] ‚≠êÔ∏è */

        .circle {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 250px;
            height: 250px;
            background: linear-gradient(180deg, #fb6a91cd, #b0d3f2c8); 
            border-radius: 50%;
            margin: 40px auto 30px;
            padding: 20px;
            color: white;
            text-align: center; 
        } 
        .circle.is-period {
            background: linear-gradient(180deg, #d6336c, #fb6a91);
        }

        .Period_in {
            font-size: 1.2em;
            margin-bottom: 5px;
            font-weight: 300;
        }
        .days {
            font-size: 3.5em;
            font-weight: bold;
            margin: 0;
        }
        .date {
            font-size: 1em;
            margin-top: 5px;
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 0 20px;
            max-width: 400px;
            margin: 0 auto;
        }
        .button-card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .self-assessment {
            font-size: 1.1em;
            font-weight: bold;
            color: #d6336c;
            margin-bottom: 5px;
        }
        .self-assessment2 {
            font-size: 0.9em;
            color: #777;
            margin: 0;
        }
        .from-btn {
            display: block;
            text-align: center;
            padding: 10px;
            margin-top: 15px;
            background-color: #ffb6c1;
            color: #d6336c;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
        }
        #setup-card {
            display: none; 
            border: 2px dashed #d6336c;
            background-color: #fff0f5;
        }
        #setup-card label {
            display: block;
            margin-top: 10px;
            font-weight: 600;
        }
        #setup-card input[type="date"] {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ffccd9;
            border-radius: 5px;
            box-sizing: border-box;
            font-family: 'Kanit';
        }
        #saveInitialDataButton {
            width: 100%;
            padding: 15px;
            background-color: #d6336c; 
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            font-family: 'Kanit';
            margin-top: 15px;
        }
        #setup-message {
            font-size: 0.9em;
            color: #d6336c;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>

    <nav class="top-nav">
        <img src="{{ url_for('static', filename='logo.jpg') }}" width="90" alt="Her track logo" style="margin: 5px 20px 5px 20px;" >
        
        <!-- ‚≠êÔ∏è [‡πÄ‡∏û‡∏¥‡πà‡∏° HTML ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] ‚≠êÔ∏è -->
        <div class="user-info">
            <span>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <strong>{{ current_user.username }}</strong>!</span>
            <a href="{{ url_for('logout') }}" class="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
        <!-- ‚≠êÔ∏è ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ‚≠êÔ∏è -->
    </nav>
        
    <div class="circle">
        <p class="Period_in">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å</p>
        <h3 class="days">... ‡∏ß‡∏±‡∏ô</h3>
        <p class="date">... ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ...</p>
    </div>

    <div class="button-group">
        
        <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ) -->
        <div id="setup-card" class="button-card">
            <p class="self-assessment">‚≠êÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</p>
            <p class="self-assessment2">
                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 2 ‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            </p>
            
            <label for="initialLastStart">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</label>
            <input type="date" id="initialLastStart"> 
            
            <label for="initialPrevStart">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤:</label>
            <input type="date" id="initialPrevStart"> 
            
            <button id="saveInitialDataButton">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô</button>
            <p id="setup-message"></p>
        </div>


        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
        <div class="button-card">
            <p class="self-assessment" style="color: #6c7d9c;">üìÖ ‡∏î‡∏π‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</p>
            <p class="self-assessment2">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á) ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</p>
            
            <a href="/dashboard" class="from-btn">‡∏î‡∏π‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</a> 
        </div>

    </div>

    <!-- (JavaScript ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
    <script>
        const thaiMonths = [
            "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
            "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
        ];

        function formatThaiDate(date) {
            const d = date.getDate();
            const m = thaiMonths[date.getMonth()];
            const y = date.getFullYear() + 543; 
            return `${d} ${m} ${y}`;
        }

        function loadHomeSummary() {
            const daysEl = document.querySelector(".days");
            const dateEl = document.querySelector(".date");
            const periodInEl = document.querySelector(".Period_in");
            const circleDiv = document.querySelector(".circle");
            const setupCard = document.getElementById('setup-card');

            fetch('/api/get_next_period')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success' && data.next_date) {
                        
                        const nextPeriodDate = new Date(data.next_date);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        const oneDay = 1000 * 60 * 60 * 24;
                        const daysUntil = Math.ceil((nextPeriodDate - today) / oneDay);

                        if (daysUntil <= 0) {
                            periodInEl.textContent = `‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
                            daysEl.textContent = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ`;
                            dateEl.textContent = `(‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${Math.abs(daysUntil)} ‡∏ß‡∏±‡∏ô)`;
                            circleDiv.classList.add('is-period'); 
                        } else {
                            periodInEl.textContent = `‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å`;
                            daysEl.textContent = `${daysUntil} ‡∏ß‡∏±‡∏ô`;
                            dateEl.textContent = `‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° ${formatThaiDate(nextPeriodDate)}`;
                            circleDiv.classList.remove('is-period');
                        }
                        
                        setupCard.style.display = 'none';

                    } else if (data.status === 'no_data') {
                        periodInEl.textContent = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`;
                        daysEl.textContent = `N/A`;
                        dateEl.textContent = `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á`;
                        setupCard.style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error("Error fetching home summary:", err);
                    periodInEl.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î`;
                    daysEl.textContent = `‚ùå`;
                    dateEl.textContent = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ`;
                });
        }
        
        function saveInitialData() {
            const lastStart = document.getElementById('initialLastStart').value;
            const prevStart = document.getElementById('initialPrevStart').value;
            const msgEl = document.getElementById('setup-message');

            if (!lastStart || !prevStart) {
                msgEl.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ä‡πà‡∏≠‡∏á";
                msgEl.style.display = 'block';
                return;
            }

            msgEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            msgEl.style.display = 'block';

            fetch('/api/initial_setup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    lastStartDate: lastStart,
                    prevStartDate: prevStart
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    msgEl.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤...";
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500); 
                } else {
                    msgEl.textContent = `‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.message}`;
                }
            })
            .catch(err => {
                msgEl.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ";
                console.error("Error saving initial data:", err);
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadHomeSummary();
            const saveBtn = document.getElementById('saveInitialDataButton');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveInitialData);
            }
        });

    </script>
</body>
</html>